# Contributor: Minoplhy <c@3qx.nl>
maintainer="Minoplhy <c@3qx.nl>"
pkgname=minoplhy-nginx-allstar
pkgver=1.29.5
pkgrel=0
pkgdesc="Nginx"
url="https://github.com/nginx/nginx"
arch="x86_64"
license="MIT"
makedepends="
    mercurial
    cmake
    make
    git
    build-base
    autoconf
    automake
    libtool
    ninja
    pkgconf
    wget
    linux-headers
    libunwind
    pcre-dev
    pcre2-dev
    zlib-dev
    libxslt-dev
    gd-dev
    openssl-dev
    perl-dev
    geoip-dev
    curl-dev
    lmdb-dev
    libxml2-dev
    yajl-dev
    sudo
"
pkgusers="nginx"
_grp_ngx="nginx"
_grp_www="www-data"
pkggroups="$_grp_ngx $_grp_www"
install="$pkgname.pre-install"
subpackages="$pkgname-openrc
	"
source="nginx-$pkgver.tar.gz::https://github.com/nginx/nginx/archive/refs/tags/release-$pkgver.tar.gz
    nginx-build.sh::https://chy.li/p-p/minoplhy/scriptbox/raw/branch/main/nginx_build_script/build.sh
	nginx.initd
	"
options="net !check" # check: no test suite
builddir=$srcdir/nginx

prepare() {
    mkdir -p "$builddir"
    default_prepare
}

build() {
    bash "$srcdir"/nginx-build.sh --lua --modsecurity --type=nginx --modsecurity-prefix="$builddir"/usr --lua-prefix="$builddir"/usr/share/lua/5.4 --luajit2-prefix="$builddir"/usr --ssl=quictls --builddir "$builddir" --source-folder="$srcdir"/nginx-release-"$pkgver"
}

package() {
    install -D -m 755 "$builddir"/nginx/objs/nginx "$pkgdir"/usr/sbin/nginx
    chown root:root "$pkgdir"/usr/sbin/nginx
    
    install -d -m 755 "$pkgdir"/usr/lib/nginx/modules
    install -D -m 755 "$builddir"/nginx/objs/*.so "$pkgdir"/usr/lib/nginx/modules
    chown -R root:root "$pkgdir"/usr/lib/nginx/modules

    install -d -m 755 "$pkgdir"/usr/include

    install -d -m 755 "$pkgdir"/usr/share/lua/5.4
    cp -r "$builddir"/usr/share/lua/5.4/* "$pkgdir"/usr/share/lua/5.4

    install -d -m 755 "$pkgdir"/usr/share/luajit-2.1/jit
    install -D -m 755 "$builddir"/usr/share/luajit-2.1/jit/* "$pkgdir"/usr/share/luajit-2.1/jit

    install -D -m 755 "$builddir"/usr/bin/modsec-rules-check "$pkgdir"/usr/bin/modsec-rules-check
    install -D -m 755 "$builddir"/usr/bin/luajit "$pkgdir"/usr/bin/luajit

    cp -r "$builddir"/usr/lib/* "$pkgdir"/usr/lib/
    install -d -m 755 "$pkgdir"/usr/lib/pkgconfig
    install -D -m 755 "$builddir"/usr/lib/pkgconfig/* "$pkgdir"/usr/lib/pkgconfig

    install -d -m 755 "$pkgdir"/usr/include/modsecurity
    cp -r "$builddir"/usr/include/modsecurity/* "$pkgdir"/usr/include/modsecurity

    install -d -m 755 "$pkgdir"/usr/include/luajit-2.1
    install -D -m 755 "$builddir"/usr/include/luajit-2.1/* "$pkgdir"/usr/include/luajit-2.1

	install -D -m 755 "$srcdir"/nginx.initd "$pkgdir"/etc/init.d/nginx
    install -d -m 755 "$pkgdir"/var/log/nginx
	chown $pkgusers:$_grp_ngx "$pkgdir"/var/log/nginx
}

sha512sums="
4d966b20950a6f49711763195cb0e9817f0080453d20a70eded51decc6235ecfecd23ff7b9f1c2814bc59c22b7c163d5fe54dc42abb3c80c3acd0dca99438aa3  nginx-1.29.5.tar.gz
10a8e0cf16acc944a0893527b82cc81aa228d387a1b69e77c25de6b3a2ab74904b5a6601cda30811db5e349c7c197b9f809c7e37c7280fa6790956780b367e87  nginx-build.sh
6f696579f2c3958d9d9c0c23e9e69e51344851aa15d29f4983a4d2feb493ac950fd6150f4a3cddc96a125261ae3cb69545fdb46218e8ab085c6c894b17b4a9a4  nginx.initd
"
