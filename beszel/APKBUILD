# Contributor: Minoplhy <c@3qx.nl>
maintainer="Minoplhy <c@3qx.nl>"
pkgname=beszel
pkgver=0.11.0
pkgrel=0
pkgdesc="Lightweight server monitoring hub with historical data, docker stats, and alerts."
url="https://beszel.dev/"
arch="x86_64 aarch64"
license="MIT"
depends="tar curl"
makedepends="go>=1.24 npm"
install="$pkgname.pre-install $pkgname-agent.pre-install"
pkgusers="beszel beszel-agent"
pkggroups="beszel beszel-agent"
subpackages="$pkgname-openrc
	$pkgname-agent
	$pkgname-agent-openrc:agent_openrc
	"
source="$pkgname-$pkgver.tar.gz::https://github.com/henrygd/beszel/archive/refs/tags/v$pkgver.tar.gz
	$pkgname.confd
	$pkgname.initd
	$pkgname-agent.confd
	$pkgname-agent.initd
	"
options="net !check" # check: no test suite

export GOCACHE="${GOCACHE:-"$srcdir/go-cache"}"
export GOTMPDIR="${GOTMPDIR:-"$srcdir"}"
export GOMODCACHE="${GOMODCACHE:-"$srcdir/go"}"

build() {
	make -j1 -C $builddir/$pkgname
}


package() {
	install -D -m 755 "$builddir"/$pkgname/build/${pkgname}_linux_* "$pkgdir"/usr/bin/$pkgname
	install -D -m 755 "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -D -m 644 "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname
	install -d -m 750 -o $pkgusers -g $pkggroups "$pkgdir"/var/lib/$pkgname

	install -D -m 755 "$builddir"/$pkgname/build/${pkgname}-agent_linux_* "$pkgdir"/usr/bin/$pkgname-agent

	install -d -m 755 -o beszel -g beszel "$pkgdir"/var/log/$pkgname
	install -d -m 755 -o beszel-agent -g beszel-agent "$pkgdir"/var/log/$pkgname-agent
}

agent() {
	pkgdesc="Beszel agent"

	amove usr/bin/$pkgname-agent
	amove var/log/$pkgname-agent
}

agent_openrc() {
	pkgdesc="Beszel agent OpenRC scripts"

	install_if="openrc ${subpkgname%-openrc}=$pkgver-r$pkgrel"
	install -D -m 755 "$srcdir"/$pkgname-agent.initd "$pkgdir"/etc/init.d/$pkgname-agent
	install -D -m 644 "$srcdir"/$pkgname-agent.confd "$pkgdir"/etc/conf.d/$pkgname-agent
	amove etc/init.d/$pkgname-agent
	amove etc/conf.d/$pkgname-agent
}

sha512sums="
2e0bda8b78b5aaa0e3d57a4b3b443f6bbe3cb6de6eadfed1aed37e4556b4c3092855b95b9450485b1a96609e08aabfa018bf60cd437291b3f9fd0ae20b50403b  beszel-0.11.0.tar.gz
daeb915d3395d1b0fa278a74e20b2eb711f6db177ea11b30d147355c37511fb5577e6ba541947f7dbfb40ffcbc78589429ee9de13862ed47f71b1968872eaae6  beszel.confd
240f1573b54a8a4a45ed6034ea6225ebb6b2e361af2fa77a5186acb941aa6aa0946ce773c86c80755e14c1a41ea5baad65a54462446bde207a65de177bc423bb  beszel.initd
404dec30f31feab4c421cf7e820486b277b0261346abe1cfe9cf7aa78b19f23692243a67b74b479051c2739b3e664d1030562fae594ece101faa8ea4cc0ed915  beszel-agent.confd
2075fcfac9a8df815b7541d1b55ce4de5327e8afeb079da8fceabe523978070c678eb035efe6815af1e6e735dc6da531634976b82c15f2e505356ca447852484  beszel-agent.initd
"