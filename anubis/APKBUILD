maintainer="fossdd <fossdd@pwned.life>"
pkgname=anubis
pkgver=1.18.0
pkgrel=2
pkgdesc="Block AI scrapers using a sha256 proof-of-work challenge"
url="https://github.com/TecharoHQ/anubis"
arch="all"
license="MIT"
makedepends="go npm bash zstd brotli"
pkgusers="anubis"
pkggroups="anubis"
install="$pkgname.pre-install"
subpackages="$pkgname-doc
    $pkgname-openrc
    "
source="$pkgname-$pkgver.tar.gz::https://github.com/TecharoHQ/anubis/archive/refs/tags/v$pkgver.tar.gz
	$pkgname.initd
    logo/*

    "
options="net !check" # check: no test suite

# secfixes:
#   1.15.2-r0:
#     - CVE-2025-24369

export GOCACHE="${GOCACHE:-"$srcdir/go-cache"}"
export GOTMPDIR="${GOTMPDIR:-"$srcdir"}"
export GOMODCACHE="${GOMODCACHE:-"$srcdir/go"}"

prepare() {
    default_prepare

    for logo in happy.webp pensive.webp sad.webp; do
        cp "$srcdir"/$logo "$builddir"/web/static/img/$logo
    done
    make deps
}

build() {
    make assets
    make prebaked-build
}

package() {
	install -Dm755 var/anubis -t "$pkgdir"/usr/bin/
	install -Dm644 LICENSE -t "$pkgdir"/usr/share/licenses/$pkgname/
    
	install -D -m 755 "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
    install -d -m 644 "$pkgdir"/etc/$pkgname
    install -d -m 755 -o $pkgusers -g $pkggroups "$pkgdir"/var/log/$pkgname
}

sha512sums="
6b85f0fc5722b14f4d9ca519705a879eed5beb87e67411e741b5f5a7e909ee20c5aa8c4350764d1e6408484a4cbb3b544590bc2c45d6be972b559e3f13fe0c75  anubis-1.18.0.tar.gz
e4909951c183bd4a7ff932fca5591a0d9aebd7aa569384a6c807d3ef9cfc00df2e0d7c872a2fa7ddbcfd60ba49f35140236ccb8d4c756ae9f81800fad22fcb21  anubis.initd
fa5fab648f9adcd46b30d1aa4ccfc366a6558a43d14f3a46df6a82262256071a8e04ab1f23957adcdda9f04c7b69d9e6a3121e4f9568b60cee6d789266180d7e  happy.webp
cfa05b48c55737efda05af0576eb4d84a3b00b849e5a41283e3723ff1e579e7f5fce230e402af5a1785db76d67d489904461425b08b2c7451adfcf00bb7adec7  pensive.webp
4f476d6700e281659cbd1bbd38d703fd68db19d862ce652400f3bec287c6195411cc239a995fde1f6cb79fc6af1872fa5885aedc0e25b9b96e19664a9e9d32a5  sad.webp
"